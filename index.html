<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日本東京・輕井澤之旅</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Config & Custom Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#f4f4f0',       /* 米色背景 */
                            card: '#ffffff',     /* 白色卡片 */
                            text: '#4a4a4a',     /* 深灰文字 */
                            accent: '#7b8d42',   /* 抹茶綠 */
                            secondary: '#a08e7e',/* 亞麻棕 */
                            alert: '#bf6363',    /* 豆沙紅 */
                            magic: '#8b5cf6'     /* AI 紫色 */
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f4f4f0;
            color: #4a4a4a;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none; /* 防止下拉重整 */
        }
        
        /* 隱藏 Scrollbar 但保留捲動功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 頁面切換動畫 */
        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            padding-bottom: 65px; /* (修改) 縮減底部避讓高度 */
        }
        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 模擬 iOS App 質感 */
        input, textarea, select {
            font-size: 16px !important; /* 防止 iOS 縮放 */
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #8b5cf6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-muji-bg px-5 pt-10 pb-4 shadow-sm border-b border-stone-200 z-10 sticky top-0">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-widest text-stone-700">TOKYO TRIP</h1>
                <p class="text-xs text-muji-secondary tracking-wider">2025.01.27 - 02.03</p>
            </div>
            <div class="flex items-center gap-3">
                 <div id="exchange-rate-display" class="text-right">
                    <span class="text-xs block text-muji-secondary">匯率</span>
                    <span class="font-mono font-bold text-muji-accent" id="header-rate">0.20</span>
                </div>
                <button onclick="openSettings()" class="text-stone-400 hover:text-stone-600 transition">
                    <i class="fas fa-cog text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-4 relative" id="main-container">
        
        <!-- SECTION 1: PLAN (行程表) -->
        <section id="plan" class="page-section active">
            <!-- Flight Card -->
            <div class="bg-white rounded-lg p-4 shadow-sm mb-4 border-l-4 border-muji-secondary">
                <h3 class="font-bold text-stone-600 mb-2"><i class="fas fa-plane text-muji-secondary mr-2"></i>航班資訊</h3>
                <div class="flex justify-between items-center text-sm mb-2">
                    <div class="text-center">
                        <span class="block text-xs text-gray-400">去程 1/27</span>
                        <span class="font-bold">MM626</span>
                    </div>
                    <div class="text-center px-2 flex-1">
                        <div class="border-b border-dashed border-stone-300 relative top-[-8px]"></div>
                        <i class="fas fa-plane text-xs text-stone-300 absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                    </div>
                    <div class="text-center">
                        <span class="block text-xs text-gray-400">10:40-14:55</span>
                        <span class="font-bold">TPE -> NRT</span>
                    </div>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <div class="text-center">
                        <span class="block text-xs text-gray-400">回程 2/3</span>
                        <span class="font-bold">MM623</span>
                    </div>
                    <div class="text-center px-2 flex-1">
                        <div class="border-b border-dashed border-stone-300 relative top-[-8px]"></div>
                        <i class="fas fa-plane text-xs text-stone-300 transform rotate-180 absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                    </div>
                    <div class="text-center">
                        <span class="block text-xs text-gray-400">10:55-14:20</span>
                        <span class="font-bold">NRT -> TPE</span>
                    </div>
                </div>
            </div>

            <!-- Accommodation Card -->
            <div class="bg-white rounded-lg p-4 shadow-sm mb-6">
                <h3 class="font-bold text-stone-600 mb-3"><i class="fas fa-bed text-muji-secondary mr-2"></i>住宿安排</h3>
                <div id="hotel-list" class="space-y-3 text-sm">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- Daily Itinerary -->
            <h3 class="text-lg font-bold text-stone-700 mb-4 pl-2 border-l-4 border-muji-accent">每日行程</h3>
            <div id="itinerary-list" class="space-y-4">
                <!-- JS Injected -->
            </div>
        </section>


        <!-- SECTION 2: GUIDE (深度導覽) -->
        <section id="guide" class="page-section">
            <article class="bg-white p-5 rounded-lg shadow-sm mb-6">
                <h2 class="text-2xl font-serif text-stone-800 mb-2">川越 Kawagoe</h2>
                <p class="text-xs text-muji-secondary mb-4 uppercase tracking-widest">Little Edo / Saitama</p>
                <div class="h-40 bg-stone-200 rounded mb-4 overflow-hidden relative">
                     <!-- Placeholder for an image -->
                     <div class="absolute inset-0 flex items-center justify-center bg-stone-200 text-stone-400">
                        <i class="fas fa-image fa-2x"></i>
                     </div>
                </div>
                <p class="text-sm leading-7 text-justify text-stone-600 mb-4">
                    川越被稱為「小江戶」，保留了大量江戶時代的藏造建築。最著名的地標是「時之鐘」，每天會有四次報時。這裡的星巴克也是必去景點，採用江戶風格庭園設計，完美融入古色古香的街道中。必吃美食包括紫薯甜點與鰻魚飯。
                </p>
                <div class="bg-muji-bg p-3 rounded text-sm text-stone-600">
                    <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>小知識：川越的鬼瓦（屋頂裝飾）有各種表情，不妨抬頭找找看。
                </div>
            </article>

            <article class="bg-white p-5 rounded-lg shadow-sm mb-6">
                <h2 class="text-2xl font-serif text-stone-800 mb-2">輕井澤 Karuizawa</h2>
                <p class="text-xs text-muji-secondary mb-4 uppercase tracking-widest">Highland Resort / Nagano</p>
                <p class="text-sm leading-7 text-justify text-stone-600 mb-4">
                    日本皇室的避暑勝地。舊輕井澤銀座通充滿異國風情，是約翰藍儂生前最愛的度假地。「雲場池」四季景色分明，湖面倒映極美。石之教堂由石頭與玻璃堆砌而成，象徵著男性的堅毅與女性的柔和，是極為神聖的建築。
                </p>
            </article>

            <!-- Embedded Map -->
            <div class="bg-white p-2 rounded-lg shadow-sm">
                <h3 class="text-sm font-bold text-stone-600 mb-2 px-2">東京迪士尼度假區</h3>
                <div class="w-full h-48 bg-stone-100 rounded overflow-hidden">
                    <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=139.8708%2C35.6243%2C139.8950%2C35.6360&amp;layer=mapnik" style="border: 1px solid #eee"></iframe>
                </div>
                <div class="text-right mt-1">
                    <a href="https://www.openstreetmap.org/#map=15/35.6301/139.8829" target="_blank" class="text-xs text-blue-500 underline">查看大地圖</a>
                </div>
            </div>
        </section>


        <!-- SECTION 3: WALLET (記帳與匯率) -->
        <section id="wallet" class="page-section">
            
            <!-- Exchange Rate Calculator -->
            <div class="bg-stone-800 text-white p-4 rounded-xl shadow-lg mb-6 sticky top-0 z-20">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs text-stone-400">匯率設定 (1 JPY = ? TWD)</label>
                    <input type="number" id="rate-input" step="0.001" value="0.20" class="w-16 bg-stone-700 text-white text-center rounded text-sm p-1 outline-none focus:ring-1 focus:ring-muji-accent">
                </div>
                
                <div class="mb-2 relative">
                    <span class="absolute left-3 top-3 text-stone-400 text-xs">¥</span>
                    <input type="text" id="calc-input" placeholder="輸入算式 (如 500+100*2)" class="w-full bg-stone-700 text-white text-2xl p-2 pl-6 rounded-lg outline-none font-mono">
                </div>
                
                <div class="flex justify-between items-center mt-2">
                    <div class="text-stone-400 text-sm">≈ NT$ <span id="twd-preview" class="text-white font-bold text-lg">0</span></div>
                    <button onclick="calculateAndAdd()" class="bg-muji-accent text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-opacity-90 active:scale-95 transition">
                        計算並填入
                    </button>
                </div>
            </div>

            <!-- Add Expense Form -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6 relative overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-stone-600">新增記帳</h3>
                    <!-- AI Scan Button -->
                    <label class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md cursor-pointer hover:opacity-90 active:scale-95 transition flex items-center gap-1">
                        <i class="fas fa-magic"></i> AI 掃描收據
                        <input type="file" accept="image/*" class="hidden" onchange="handleAiScan(this)">
                    </label>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input type="text" id="item-name" placeholder="品項 (如: 拉麵)" class="col-span-2 border border-stone-200 rounded p-2 text-sm bg-stone-50">
                    <input type="number" id="item-price" placeholder="日幣" class="col-span-1 border border-stone-200 rounded p-2 text-sm bg-stone-50">
                </div>
                
                <div class="flex gap-2">
                    <!-- Photo Upload Button -->
                    <label class="flex-1 bg-stone-100 text-stone-500 border border-stone-200 border-dashed rounded flex flex-col items-center justify-center p-2 cursor-pointer active:bg-stone-200 transition">
                        <i class="fas fa-camera mb-1"></i>
                        <span class="text-xs" id="photo-label">存底圖</span>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoSelect(this)">
                    </label>
                    <button onclick="addExpense()" class="flex-[2] bg-stone-700 text-white rounded p-2 shadow-sm font-bold hover:bg-stone-600 active:scale-95 transition">
                        <i class="fas fa-plus mr-1"></i> 記一筆
                    </button>
                </div>
                <div id="photo-preview-area" class="mt-2 hidden">
                    <img id="preview-img" class="h-16 w-16 object-cover rounded border border-stone-200" src="">
                    <span class="text-xs text-green-600 ml-2"><i class="fas fa-check-circle"></i> 圖片已準備</span>
                </div>

                <!-- AI Loading Overlay for Card -->
                <div id="ai-scan-loading" class="absolute inset-0 bg-white/90 z-10 hidden flex flex-col items-center justify-center">
                    <div class="loader mb-2 border-t-violet-500"></div>
                    <span class="text-xs text-violet-600 font-bold animate-pulse">Gemini 正在辨識收據...</span>
                </div>
            </div>

            <!-- Expense History -->
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-stone-600">消費紀錄</h3>
                <span class="text-xs text-muji-secondary" id="total-expense">總計: ¥0</span>
            </div>
            <div id="expense-list" class="space-y-3 pb-20">
                <!-- JS Injected items -->
                <div class="text-center py-10 text-stone-300 text-sm">尚未有記帳資料</div>
            </div>
        </section>


        <!-- SECTION 4: LISTS (清單) -->
        <section id="lists" class="page-section">
            
            <!-- Check List -->
            <div class="bg-white rounded-lg shadow-sm mb-6 overflow-hidden">
                <div class="bg-muji-secondary text-white p-3 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-suitcase mr-2"></i>行前準備 CheckList</h3>
                    <button onclick="resetChecklist()" class="text-xs underline opacity-80">重置</button>
                </div>
                <div id="checklist-container" class="divide-y divide-stone-100">
                    <!-- JS Injected -->
                </div>
                <div class="p-2 bg-stone-50">
                     <div class="flex gap-2">
                        <input type="text" id="new-todo" placeholder="新增項目..." class="flex-1 border border-stone-200 rounded px-2 py-1 text-sm">
                        <button onclick="addTodo()" class="bg-stone-600 text-white px-3 py-1 rounded text-sm">新增</button>
                     </div>
                </div>
            </div>

            <!-- Memos -->
            <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-stone-600 mb-3"><i class="fas fa-pen-nib text-muji-secondary mr-2"></i>個人備忘錄</h3>
                <textarea id="memo-area" class="w-full h-40 border border-stone-200 rounded p-3 text-sm leading-relaxed bg-stone-50 focus:bg-white transition resize-none" placeholder="輸入文字或網址..."></textarea>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-stone-400">網址將自動轉換為按鈕</span>
                    <button onclick="saveMemo()" class="bg-muji-accent text-white px-4 py-1 rounded text-sm shadow-sm">儲存</button>
                </div>
                <div id="memo-links" class="mt-4 flex flex-wrap gap-2">
                    <!-- Links parsed from textarea -->
                </div>
            </div>
        </section>


        <!-- SECTION 5: INFO (資訊) -->
        <section id="info" class="page-section">
            
            <!-- AI Translator Card -->
            <div class="bg-gradient-to-br from-violet-50 to-fuchsia-50 p-5 rounded-lg shadow-sm border border-violet-100 mb-6">
                <div class="flex items-center gap-2 mb-3 text-violet-700">
                    <i class="fas fa-language text-xl"></i>
                    <h3 class="font-bold">AI 日文翻譯蒟蒻</h3>
                    <span class="text-[10px] bg-violet-200 text-violet-800 px-1 rounded">Gemini</span>
                </div>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="trans-input" placeholder="輸入中文 (例如: 我不吃辣)" class="flex-1 border border-violet-200 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-violet-400 outline-none">
                    <button onclick="handleTranslate()" class="bg-violet-500 text-white px-4 py-2 rounded text-sm font-bold shadow-sm active:scale-95 transition">
                        <i class="fas fa-magic"></i>
                    </button>
                </div>
                <!-- Translation Result -->
                <div id="trans-result" class="bg-white rounded p-3 text-sm text-stone-600 hidden border border-violet-100">
                    <div id="trans-loading" class="hidden flex items-center gap-2 text-violet-400">
                        <div class="loader border-t-violet-400 w-4 h-4"></div> 翻譯中...
                    </div>
                    <div id="trans-content"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-white p-4 rounded-lg shadow-sm flex flex-col items-center justify-center text-center aspect-square active:scale-95 transition">
                    <i class="fas fa-cloud-sun text-3xl text-blue-400 mb-2"></i>
                    <span class="font-bold text-stone-600">日本氣象廳</span>
                    <span class="text-xs text-stone-400 mt-1">天氣預報</span>
                </a>
                <a href="https://www.google.com/maps/search/?api=1&query=police+station+near+me" target="_blank" class="bg-white p-4 rounded-lg shadow-sm flex flex-col items-center justify-center text-center aspect-square active:scale-95 transition">
                    <i class="fas fa-shield-alt text-3xl text-red-400 mb-2"></i>
                    <span class="font-bold text-stone-600">緊急求助</span>
                    <span class="text-xs text-stone-400 mt-1">警察/醫院</span>
                </a>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-5 mt-6 border-l-4 border-muji-alert">
                <h3 class="font-bold text-stone-700 mb-3">重要注意事項</h3>
                <ul class="list-disc list-inside text-sm text-stone-600 space-y-2">
                    <li>日本電壓為 100V，插座為雙平腳（與台灣同）。</li>
                    <li>電車內請勿通話，手機請設為靜音。</li>
                    <li>多數餐廳禁帶外食，且無打包服務。</li>
                    <li>垃圾請隨身攜帶，車站或超商才有垃圾桶。</li>
                    <li>購物滿 5000 日圓（未稅）可辦理退稅，需出示護照。</li>
                </ul>
            </div>

             <div class="bg-white rounded-lg shadow-sm p-5 mt-6">
                <h3 class="font-bold text-stone-700 mb-3">緊急聯絡</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between border-b border-stone-100 pb-2">
                        <span>報警 (Police)</span>
                        <a href="tel:110" class="text-blue-500 font-bold">110</a>
                    </div>
                    <div class="flex justify-between border-b border-stone-100 pb-2">
                        <span>救護車/火警 (Fire/Ambulance)</span>
                        <a href="tel:119" class="text-red-500 font-bold">119</a>
                    </div>
                    <div class="flex justify-between">
                        <span>台北駐日經濟文化代表處</span>
                        <a href="tel:+81-3-3280-7811" class="text-stone-700 font-bold">03-3280-7811</a>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                 <button onclick="clearAllData()" class="text-xs text-stone-300 underline p-2">清除所有 App 資料 (Reset)</button>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <!-- (修改) 增大字體 text-xs，移除 mb 以維持高度 -->
    <nav class="bg-white border-t border-stone-200 flex justify-around items-center pb-2 pt-2 text-xs font-medium text-stone-400 z-50 fixed bottom-0 w-full">
        <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center py-0.5 w-1/5 text-muji-accent" data-target="plan">
            <i class="fas fa-calendar-alt text-base mb-0"></i>
            <span>行程</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center py-0.5 w-1/5" data-target="guide">
            <i class="fas fa-book-open text-base mb-0"></i>
            <span>導覽</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center py-0.5 w-1/5" data-target="wallet">
            <i class="fas fa-wallet text-base mb-0"></i>
            <span>記帳</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center py-0.5 w-1/5" data-target="lists">
            <i class="fas fa-tasks text-base mb-0"></i>
            <span>清單</span>
        </button>
        <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center py-0.5 w-1/5" data-target="info">
            <i class="fas fa-info-circle text-base mb-0"></i>
            <span>資訊</span>
        </button>
    </nav>

    <!-- Modal for Large Image View -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <img id="modal-img" src="" class="max-w-full max-h-full rounded">
    </div>

    <!-- Settings Modal (For API Key & Model Selection) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-5 w-full max-w-sm">
            <h3 class="font-bold text-stone-700 mb-3"><i class="fas fa-robot text-muji-magic mr-2"></i>AI 功能設定</h3>
            
            <div class="mb-4">
                <label class="text-xs text-stone-500 mb-1 block">API Key (Google Gemini)</label>
                <input type="password" id="api-key-input" placeholder="Paste API Key here..." class="w-full border border-stone-200 rounded p-2 text-sm">
            </div>

            <div class="mb-4">
                <label class="text-xs text-stone-500 mb-1 block">AI Model (如果失敗請更換)</label>
                <select id="model-select" class="w-full border border-stone-200 rounded p-2 text-sm bg-white">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Default)</option>
                    <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash-8B (Fast)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp (New)</option>
                </select>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeSettings()" class="text-stone-400 text-sm px-3 py-1">取消</button>
                <button onclick="saveSettings()" class="bg-stone-700 text-white px-4 py-1 rounded text-sm">儲存</button>
            </div>
            <p class="text-[10px] text-stone-300 mt-2 text-center">Settings stored locally.</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- Data Definitions ---
        const hotels = [
            { name: "Spa & Hotel Maihama Eurasia", address: "Chiba, Urayasu, Chidori, 13-20", note: "迪士尼周邊" },
            { name: "Hotel Rosso Karuizawa", address: "154-2 Karuizawahigashi, Nagano", note: "輕井澤車站旁" },
            { name: "Hotel Kangetsuso Ueno", address: "2 Chome-14-28 Ueno, Taito City, Tokyo", note: "上野鬧區" }
        ];

        const itinerary = [
            { day: "D1", date: "1/27 (二)", title: "抵日・舞濱入住", highlight: false, content: "桃園機場 -> 成田機場 -> 前往舞濱 Check-in -> 休息/周邊逛逛" },
            { day: "D2", date: "1/28 (三)", title: "東京迪士尼陸地樂園", highlight: true, content: "全日迪士尼 Land (建議提早入園排隊)" },
            { day: "D3", date: "1/29 (四)", title: "東京迪士尼海洋", highlight: true, content: "全日迪士尼 Sea (欣賞夜間遊行)" },
            { day: "D4", date: "1/30 (五)", title: "川越半日遊", highlight: false, content: "移動至東京 -> 前往川越 (冰川神社、藏造老街、鐘樓) -> 前往輕井澤" },
            { day: "D5", date: "1/31 (六)", title: "輕井澤與自然", highlight: false, content: "搭新幹線前往輕井澤 -> 雲場池 -> 舊輕井澤銀座通 -> 聖保羅天主教堂 -> 白絲瀑布" },
            { day: "D6", date: "2/1 (日)", title: "星野區與 Outlet", highlight: false, content: "中輕井澤星野區 -> 榆樹街小鎮 -> 石之教堂/高原教堂 -> 村民食堂午餐 -> 王子購物廣場 Outlet -> 返回東京" },
            { day: "D7", date: "2/2 (一)", title: "東京市區巡禮", highlight: false, content: "上野 -> 根津神社 -> 谷中銀座 -> 麻布台之丘 -> Shibuya Sky (澀谷夜景)" },
            { day: "D8", date: "2/3 (二)", title: "返台", highlight: true, content: "搭 Skyliner 前往成田機場 -> 免稅店採購 -> 搭機回台灣" }
        ];

        const defaultTodos = [
            "護照 (有效期限6個月以上)", "Visit Japan Web 填寫", "網卡/漫遊開通", "日幣現金", "信用卡/西瓜卡", 
            "充電器/轉接頭", "個人常備藥", "迪士尼門票 QR Code"
        ];

        // --- App State ---
        let currentRate = 0.20;
        let expenses = [];
        let todos = [];
        let tempPhotoData = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderHotels();
            renderItinerary();
            renderExpenses();
            renderTodos();
            renderMemoLinks();
            
            // Tab Handling
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update UI
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('text-muji-accent');
                        b.classList.add('text-stone-400');
                    });
                    this.classList.remove('text-stone-400');
                    this.classList.add('text-muji-accent');

                    // Show Section
                    const target = this.dataset.target;
                    switchTab(target);
                });
            });

            // Rate Input Listener
            document.getElementById('rate-input').addEventListener('input', (e) => {
                currentRate = parseFloat(e.target.value) || 0.20;
                document.getElementById('header-rate').innerText = currentRate;
                localStorage.setItem('japan_rate', currentRate);
                calcRate(); // Update preview
                renderExpenses(); // Update list display
            });

            // Calculator Input Listener
            document.getElementById('calc-input').addEventListener('input', calcRate);
        });

        // --- Core Functions ---

        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function loadData() {
            // Rate
            const savedRate = localStorage.getItem('japan_rate');
            if (savedRate) {
                currentRate = parseFloat(savedRate);
                document.getElementById('rate-input').value = currentRate;
            } else {
                 document.getElementById('rate-input').value = currentRate;
            }
            document.getElementById('header-rate').innerText = currentRate;

            // Expenses
            const savedExp = localStorage.getItem('japan_expenses');
            if (savedExp) expenses = JSON.parse(savedExp);

            // Todos
            const savedTodos = localStorage.getItem('japan_todos');
            if (savedTodos) {
                todos = JSON.parse(savedTodos);
            } else {
                todos = defaultTodos.map(t => ({ text: t, done: false }));
            }

            // Memo
            const savedMemo = localStorage.getItem('japan_memo');
            if (savedMemo) document.getElementById('memo-area').value = savedMemo;
        }

        // --- Render Functions ---

        function renderHotels() {
            const container = document.getElementById('hotel-list');
            container.innerHTML = hotels.map(h => `
                <div class="border-b border-stone-100 last:border-0 pb-2 last:pb-0">
                    <div class="font-bold text-stone-700">${h.name}</div>
                    <div class="text-xs text-stone-400 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${h.address}</div>
                    <div class="mt-2 flex gap-2">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name + ' ' + h.address)}" target="_blank" class="bg-stone-100 hover:bg-stone-200 text-stone-600 px-3 py-1 rounded text-xs transition">Google Maps</a>
                        <span class="bg-muji-bg text-muji-secondary px-2 py-1 rounded text-xs">${h.note}</span>
                    </div>
                </div>
            `).join('');
        }

        // --- Auto Link Function ---
        function autoLink(text) {
            const keywords = [
                "冰川神社", "藏造老街", "鐘樓", "雲場池", "舊輕井澤銀座通", 
                "聖保羅天主教堂", "白絲瀑布", "中輕井澤星野區", "榆樹街小鎮", 
                "石之教堂", "高原教堂", "村民食堂", "王子購物廣場", 
                "根津神社", "谷中銀座", "麻布台之丘", "Shibuya Sky"
            ];
            
            let linkedText = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(keyword, 'g');
                // 使用 Google Maps Search Link
                const link = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(keyword)}" target="_blank" class="text-blue-600 font-medium underline decoration-blue-300 underline-offset-2 hover:text-blue-800">${keyword}</a>`;
                linkedText = linkedText.replace(regex, link);
            });
            return linkedText;
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = itinerary.map((item, index) => `
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${item.highlight ? 'border-muji-alert' : 'border-stone-300'}">
                    <div class="flex justify-between items-baseline mb-2">
                        <h4 class="font-bold text-lg text-stone-800"><span class="text-sm font-normal text-muji-secondary mr-2">${item.day} ${item.date}</span><br>${item.title}</h4>
                    </div>
                    <!-- Applied autoLink here -->
                    <p class="text-sm text-stone-600 leading-relaxed mb-3">${autoLink(item.content)}</p>
                    ${item.highlight ? `<span class="inline-block bg-red-50 text-red-600 text-xs px-2 py-1 rounded font-bold"><i class="fas fa-exclamation-circle mr-1"></i>重點行程</span>` : ''}
                    <div class="mt-2 text-right">
                         <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}" target="_blank" class="text-xs text-blue-500 underline">搜尋地點</a>
                    </div>
                </div>
            `).join('');
        }

        // --- Wallet Logic ---

        function calcRate() {
            const input = document.getElementById('calc-input').value;
            const display = document.getElementById('twd-preview');
            
            try {
                if(!input) {
                    display.innerText = "0";
                    return;
                }
                const safeInput = input.replace(/[^0-9+\-*/().]/g, '');
                const yen = eval(safeInput);
                if (!isNaN(yen)) {
                    const twd = Math.round(yen * currentRate);
                    display.innerText = twd;
                }
            } catch (e) {}
        }

        function calculateAndAdd() {
            const input = document.getElementById('calc-input').value;
            if(!input) return;
            try {
                const safeInput = input.replace(/[^0-9+\-*/().]/g, '');
                const result = eval(safeInput);
                if(!isNaN(result)) {
                    document.getElementById('item-price').value = Math.floor(result);
                    document.getElementById('calc-input').value = ""; // clear calc
                    document.getElementById('twd-preview').innerText = "0";
                    document.getElementById('item-name').focus();
                }
            } catch(e) {}
        }

        function handlePhotoSelect(input) {
            if (input.files && input.files[0]) {
                processImage(input.files[0], (base64) => {
                    tempPhotoData = base64;
                    document.getElementById('preview-img').src = tempPhotoData;
                    document.getElementById('photo-preview-area').classList.remove('hidden');
                    document.getElementById('photo-label').innerText = "已選取";
                });
            }
        }

        function processImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 500; // Slightly larger for AI
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.7)); 
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function addExpense() {
            const name = document.getElementById('item-name').value;
            const price = parseFloat(document.getElementById('item-price').value);
            
            if (!name || isNaN(price)) {
                alert("請輸入名稱與金額");
                return;
            }

            const newExpense = {
                id: Date.now(),
                name: name,
                yen: price,
                img: tempPhotoData,
                date: new Date().toLocaleDateString()
            };

            expenses.unshift(newExpense);
            saveExpenses();
            renderExpenses();

            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('expense-photo').value = '';
            tempPhotoData = null;
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('photo-label').innerHTML = '<i class="fas fa-camera mb-1"></i><span class="text-xs">存底圖</span>';
        }

        function deleteExpense(id) {
            if(confirm('確定刪除此筆紀錄？')) {
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses();
                renderExpenses();
            }
        }

        function saveExpenses() {
            try {
                localStorage.setItem('japan_expenses', JSON.stringify(expenses));
            } catch (e) {
                alert("儲存失敗！可能是照片太多佔滿空間，請刪除部分舊紀錄。");
            }
        }

        function renderExpenses() {
            const container = document.getElementById('expense-list');
            let totalYen = 0;

            if (expenses.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-stone-300 text-sm">尚未有記帳資料</div>';
                document.getElementById('total-expense').innerText = '總計: ¥0';
                return;
            }

            container.innerHTML = expenses.map(e => {
                totalYen += e.yen;
                const twd = Math.round(e.yen * currentRate);
                return `
                <div class="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3 overflow-hidden">
                        ${e.img ? `<img src="${e.img}" class="w-10 h-10 rounded object-cover border border-stone-100 flex-shrink-0" onclick="showImage('${e.img}')">` : '<div class="w-10 h-10 bg-stone-100 rounded flex items-center justify-center text-stone-300"><i class="fas fa-shopping-bag"></i></div>'}
                        <div class="min-w-0">
                            <div class="font-bold text-stone-700 truncate">${e.name}</div>
                            <div class="text-xs text-stone-400">${e.date}</div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div class="font-bold text-stone-800">¥${e.yen.toLocaleString()}</div>
                        <div class="text-xs text-muji-secondary">≈ $${twd.toLocaleString()}</div>
                    </div>
                    <button onclick="deleteExpense(${e.id})" class="ml-2 text-stone-300 hover:text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
                </div>
                `;
            }).join('');

            const totalTwd = Math.round(totalYen * currentRate);
            document.getElementById('total-expense').innerText = `總計: ¥${totalYen.toLocaleString()} (約 NT$${totalTwd.toLocaleString()})`;
        }

        function showImage(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('image-modal').classList.remove('hidden');
        }

        // --- Lists Logic ---

        function renderTodos() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = todos.map((t, i) => `
                <div class="p-3 flex items-center gap-3 ${t.done ? 'bg-stone-50' : 'bg-white'}">
                    <button onclick="toggleTodo(${i})" class="text-xl ${t.done ? 'text-muji-accent' : 'text-stone-300'}">
                        <i class="fas ${t.done ? 'fa-check-square' : 'fa-square'}"></i>
                    </button>
                    <span class="${t.done ? 'line-through text-stone-400' : 'text-stone-700'} flex-1">${t.text}</span>
                    <button onclick="deleteTodo(${i})" class="text-stone-300 text-xs px-2"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
            localStorage.setItem('japan_todos', JSON.stringify(todos));
        }

        function toggleTodo(index) {
            todos[index].done = !todos[index].done;
            renderTodos();
        }

        function addTodo() {
            const input = document.getElementById('new-todo');
            const text = input.value.trim();
            if (text) {
                todos.push({ text: text, done: false });
                input.value = '';
                renderTodos();
            }
        }

        function deleteTodo(index) {
            todos.splice(index, 1);
            renderTodos();
        }

        function resetChecklist() {
            if(confirm("重置清單回到預設狀態？")) {
                todos = defaultTodos.map(t => ({ text: t, done: false }));
                renderTodos();
            }
        }

        function saveMemo() {
            const text = document.getElementById('memo-area').value;
            localStorage.setItem('japan_memo', text);
            renderMemoLinks();
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "已儲存";
            btn.classList.add('bg-stone-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-stone-600');
            }, 1000);
        }

        function renderMemoLinks() {
            const text = document.getElementById('memo-area').value;
            const container = document.getElementById('memo-links');
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);

            if (matches) {
                container.innerHTML = matches.map(url => `
                    <a href="${url}" target="_blank" class="bg-stone-200 hover:bg-stone-300 text-stone-600 px-3 py-1 rounded-full text-xs truncate max-w-full flex items-center gap-1">
                        <i class="fas fa-link"></i> ${new URL(url).hostname}
                    </a>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

        function clearAllData() {
            if(confirm("警告：這將會刪除所有的記帳、清單與備忘錄資料，無法復原。確定嗎？")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- GEMINI AI FEATURES ---

        function openSettings() {
            const savedKey = localStorage.getItem('gemini_api_key') || '';
            const savedModel = localStorage.getItem('gemini_model') || 'gemini-1.5-flash';
            
            document.getElementById('api-key-input').value = savedKey;
            document.getElementById('model-select').value = savedModel;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-select').value;
            
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            
            closeSettings();
            alert("設定已儲存！");
        }

        function getApiKey() {
            const userKey = localStorage.getItem('gemini_api_key');
            // IMPORTANT: If running in immersive preview, environment variable might be available.
            // But for downloaded file, user must provide key.
            const envKey = (typeof apiKey !== 'undefined') ? apiKey : ""; 
            return userKey || envKey;
        }

        async function callGemini(payload) {
            const key = getApiKey();
            if (!key) {
                openSettings();
                throw new Error("No API Key");
            }

            // Get selected model, default to 1.5 flash if nothing saved
            const model = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "API Error: " + response.statusText);
            }
            return await response.json();
        }

        // 1. AI Receipt Scanner
        function handleAiScan(input) {
            if (input.files && input.files[0]) {
                const overlay = document.getElementById('ai-scan-loading');
                overlay.classList.remove('hidden');
                
                processImage(input.files[0], async (base64) => {
                    const cleanBase64 = base64.split(',')[1];
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: "Analyze this receipt image. Extract the main item name (a short summary in Traditional Chinese, e.g. '超商零食' or '拉麵') and the total amount in Yen. Return ONLY raw JSON format: { \"name\": \"string\", \"price\": number }. If it is not a receipt or unclear, return null." },
                                { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    };

                    try {
                        const data = await callGemini(payload);
                        const text = data.candidates[0].content.parts[0].text;
                        const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(jsonText);

                        if (result) {
                            document.getElementById('item-name').value = result.name;
                            document.getElementById('item-price').value = result.price;
                            // Also set the image as the receipt photo
                            tempPhotoData = base64;
                            document.getElementById('preview-img').src = tempPhotoData;
                            document.getElementById('photo-preview-area').classList.remove('hidden');
                            document.getElementById('photo-label').innerText = "已選取";
                        } else {
                            alert("無法辨識收據內容，請手動輸入。");
                        }
                    } catch (e) {
                        if (e.message === "No API Key") {
                             // Modal will open automatically
                        } else {
                            alert("辨識失敗: " + e.message + "\n\n請嘗試在設定中更換 AI 模型 (如 Gemini 1.5 Pro)");
                        }
                    } finally {
                        overlay.classList.add('hidden');
                        input.value = ''; // reset
                    }
                });
            }
        }

        // 2. AI Translator
        async function handleTranslate() {
            const text = document.getElementById('trans-input').value.trim();
            if (!text) return;

            const loading = document.getElementById('trans-loading');
            const resultDiv = document.getElementById('trans-result');
            const contentDiv = document.getElementById('trans-content');

            resultDiv.classList.remove('hidden');
            loading.classList.remove('hidden');
            contentDiv.innerHTML = '';

            const payload = {
                contents: [{
                    parts: [{
                        text: `You are a helpful translator for a traveler in Japan. Translate the following Traditional Chinese text to Japanese. 
                        Provide the output in this specific HTML format (no markdown code blocks):
                        <div class="text-lg font-bold text-stone-800 mb-1">{Japanese Text}</div>
                        <div class="text-xs text-stone-400 mb-2 font-mono">{Romaji Pronunciation}</div>
                        <div class="text-xs text-violet-600 bg-violet-50 p-2 rounded"><i class="fas fa-info-circle mr-1"></i>{A very brief politeness tip or cultural note if applicable}</div>
                        
                        Input: "${text}"`
                    }]
                }]
            };

            try {
                const data = await callGemini(payload);
                const html = data.candidates[0].content.parts[0].text;
                // Remove markdown code blocks if AI adds them
                contentDiv.innerHTML = html.replace(/```html/g, '').replace(/```/g, '');
            } catch (e) {
                 if (e.message !== "No API Key") {
                    contentDiv.innerText = "翻譯失敗: " + e.message + "\n(請嘗試在設定中更換 AI 模型)";
                 }
            } finally {
                loading.classList.add('hidden');
            }
        }

    </script>
</body>
</html>